user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}
http{
	# 请求速率限制区：基于客户端IP，每秒10请求
	limit_req_zone $binary_remote_addr zone=req_zone:10m rate=10r/s;
	limit_req_zone $binary_remote_addr zone=static_zone:10m rate=20r/s;
	# 并发连接数限制区：基于客户端IP，单IP最大50连接
    limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
	
	server {
		listen 8080;
		server_name localhost;

		# 全局连接数限制（作用于整个server）
		limit_conn conn_zone 20;      # 单IP最大20并发连接
		limit_conn_status 429;        # 超出限制时返回429状态码 
		limit_conn_log_level warn;    # 记录警告级别日志

		location / {
			root /usr/share/nginx/html;  # 容器内静态资源路径
			index index.html index.htm;
			try_files $uri $uri/ /index.html;  # 支持Vue Router的history模式
			
			# 请求速率限制
			limit_req zone=static_zone burst=40 nodelay; 
			limit_req_status 429;
		}
		
		# API请求反向代理（核心配置）
		location /api/ {                      # 匹配所有以/api/开头的请求
			# 请求速率限制
			limit_req zone=req_zone burst=20 nodelay; 
			limit_req_status 429;

			proxy_pass http://gunicorn-app:5000/;   # 转发到后端端口
			proxy_set_header Host $host;         # 传递原始域名
			proxy_set_header X-Real-IP $remote_addr;          # 传递客户端真实IP
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 请求链IP记录
			proxy_set_header X-Forwarded-Proto $scheme;       # 传递协议类型
			}
			error_page 500 502 503 504 /50x.html;
			location = /50x.html {
			root html;
		}
		# 自定义限流错误响应
		error_page 429 @ratelimited;
		location @ratelimited {
			return 429 '{"code": 429, "message": "Too Many Requests"}';
			add_header Content-Type application/json;
		}
	}
}

